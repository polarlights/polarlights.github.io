<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>MongoDB特点 - Polarlights</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="polarlights" />
  <meta name="description" content="数据类型丰富。 MongoDB是面向文档的数据库，不是关系型数据库。它将原来关系型数据库的&#34;`行`&#34;概念变换为更为灵活的&#34;`文档`&#34;模型。面向" />

  <meta name="keywords" content="ruby, java, go, microservice, spring" />






<meta name="generator" content="Hugo 0.67.0" />


<link rel="canonical" href="http://localhost:1313/post/notes-about-mongodb/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.fa3d941d1d0e0ddc985804227feabffea55c89883eb0af34e0532a7ae9135151.css" integrity="sha256-&#43;j2UHR0ODdyYWAQif&#43;q//qVciYg&#43;sK804FMqeukTUVE=" media="screen" crossorigin="anonymous">




<link rel="stylesheet" href="/css/prism.css">

<link rel="stylesheet" href="/css/adoc.css">

<link rel="stylesheet" href="/css/github.css">


<meta property="og:title" content="MongoDB特点" />
<meta property="og:description" content="数据类型丰富。 MongoDB是面向文档的数据库，不是关系型数据库。它将原来关系型数据库的&#34;`行`&#34;概念变换为更为灵活的&#34;`文档`&#34;模型。面向" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/post/notes-about-mongodb/" />
<meta property="article:published_time" content="2012-07-30T04:00:00+08:00" />
<meta property="article:modified_time" content="2012-07-30T04:00:00+08:00" />
<meta itemprop="name" content="MongoDB特点">
<meta itemprop="description" content="数据类型丰富。 MongoDB是面向文档的数据库，不是关系型数据库。它将原来关系型数据库的&#34;`行`&#34;概念变换为更为灵活的&#34;`文档`&#34;模型。面向">
<meta itemprop="datePublished" content="2012-07-30T04:00:00&#43;08:00" />
<meta itemprop="dateModified" content="2012-07-30T04:00:00&#43;08:00" />
<meta itemprop="wordCount" content="5357">



<meta itemprop="keywords" content="mongodb,nosql," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MongoDB特点"/>
<meta name="twitter:description" content="数据类型丰富。 MongoDB是面向文档的数据库，不是关系型数据库。它将原来关系型数据库的&#34;`行`&#34;概念变换为更为灵活的&#34;`文档`&#34;模型。面向"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-31475638-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">



</head>

<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Polarlights</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/">Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/tags/">Tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/categories/">Categories</a>
          
        
      </li>
    

    
  </ul>
</nav>


  
  






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      Polarlights
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/">Home</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/post/">Archives</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/tags/">Tags</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/categories/">Categories</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">MongoDB特点</h1>
      
      <div class="post-meta">
        <time datetime="2012-07-30" class="post-time">
          2012-07-30
        </time>
        
        

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    
  </div>
</div>

    
    <div class="post-content">
      <section id="preamble" aria-label="Preamble"><div class="ulist"><ul><li>数据类型丰富。 MongoDB是面向文档的数据库，不是关系型数据库。它将原来关系型数据库的"`行`"概念变换为更为灵活的"`文档`"模型。面向文档的方式可以将文档或数组内嵌进来，用一条记录表示可能需要关系数据库多个表关联的数据。</li><li>扩展容易 MongoDB采用面向文档的数据模型可以很方便的在多台服务器之间分割数据，环科院实现集群的数据和负载，自动重排文档。</li><li><p>功能丰富 MongoDB支持通用辅助索引，能进行多种快速查询，也提供唯一、复合和地理空间索引能力。</p><p>可以直接在服务器端存取Javascript的函数和值。</p>
<p>支持MapReduce等聚合工具。</p>
<p>集合的大小有上限，对某些数据特别有用。</p>
<p>MongoDB支持易用的协议存储大型文件和文件的元数据。</p></li><li>高速 MongoDB使用自己的传输协议作为与服务器交互的方式，对文档进行动态填充，预分配数据文件，用空间换取性能的文档。</li><li>易管理 MongoDB尽量让服务器自己来管理自己，而且还可以自己在主服务器down掉的时候，自动切换到备用服务器。它的管理理念就是尽量让服务器自动配置，让用户能在需要的时候调整设置。</li></ul></div></section>
<section class="doc-section level-0"><h1 id="_mongodb基础">MongoDB基础</h1><div class="open-block partintro"><div class="content"><p>MongoDB的基本单元是：文档。每个文档都有一个特殊的键:"_id。MongoDB的单个实例可以容纳多个独立的数据库，每个数据库都有自己的集合和权限。</p>
<p>文档是MongoDB的基础，多个键及其相关的值有序地放在一起就构成了文档。</p>
<p>MongoDB文档的键是字符串，但是这些键不能使用<code>\0</code>（表示键的结束),<code>.</code>和<code>$</code>一般 不可以使用，以下划线"_"开头的键是保留的，一般不建议使用。</p>
<p>MongoDB的键不可以有重复的。</p>
<p>文档是构成MongoDB的基本单元，多个文档组合到一起就是<code>集合</code>。集合的名字不能包含<code>\0</code>，<code>system.</code>以及<code>$</code>。</p>
<p>多个集合构成了一个数据库，数据库的名字不能使用空字符串，不能含<code>.</code>,<code>$</code>,<code>/</code>,<code>\</code>和<code>\0</code>，不能超过64字节，全部小写。</p></div></div>
<section class="doc-section level-1"><h2 id="_插入">插入</h2><div class="literal-block"><pre>post = { "title": "My First Blog", "content": "test,test","date": new Date() }
db.blog.insert(post)</pre></div></section>
<section class="doc-section level-1"><h2 id="_查询">查询</h2><div class="literal-block"><pre>db.blog.find()  #默认返回20条记录</pre></div></section>
<section class="doc-section level-1"><h2 id="_更新">更新</h2><div class="literal-block"><pre>update至少需要2个参数，第一个是更新文档的限定条件，第二个是新的文档。
post.comments = ["yeah, It is cool."]
db.blog.update({title: "My First Blog"}, post)</pre></div></section>
<section class="doc-section level-1"><h2 id="_删除">删除</h2><div class="literal-block"><pre>remove默认删除集合内的所有文档，当然也可以设置限定条件。
db.blog.remove({title: "My First Blog"})</pre></div>
<hr></section>
<section class="doc-section level-1"><h2 id="_数据类型">数据类型</h2><p>MongoDB的文档类似JSON，在概念上和JavaScript相似。JSON包含null, 布尔，整数、字符串、数组和对象几种类型。MongoDB扩展了JSON类型。MongoDB还包括64位浮点数，符号、对象ID，日期，正则表达式、代码，二进制数据，最大值，最小值和未定义的类型，内嵌文档等等。</p>
<section class="doc-section level-2"><h3 id="_数字">数字</h3><p>MongoDB的数字都是以64位浮点数的形式保存的。内嵌文档表示shell显示的是一个用6位浮点数近似表示的64位整数。如果插入的64位整数不能精确地表示为双精度数字显示，shell会添加两个键top和bottom，分别表示高32位和低32位。</p></section>
<section class="doc-section level-2"><h3 id="_date">Date</h3><p>MongoDB的日期通常使用new Date()来记录，如果使用Date()函数就会导致日期和字符串不匹配，对更新表和查询带来问题。它记录的是从标准纪元开始的毫秒数，但是不包含任何时区相关的数据，如果要保存，那么就需要额外的字段来保存了。</p></section>
<section class="doc-section level-2"><h3 id="_数组">数组</h3><p>数组可以包含不同数据类型的元素。MongoDB可以"`理解`"文档中的数组的结构，并可以深入数组内部对数组进行操作。</p></section>
<section class="doc-section level-2"><h3 id="_内嵌文档">内嵌文档</h3><p>内嵌文档是把MongoDB文档作为另一个文档键的一个值。这样数据组织的更加自然，而且不用保存成扁平结构的。</p></section>
<section class="doc-section level-2"><h3 id="_对象id">对象ID</h3><p>MongoDB中存储的每个文档都有一个"_id"键，这个键的值可以是任何类型的，默认为ObjectId对象。在每个集合里面，每个文档都有唯一的"_id"值，来确保集合里面的每个文档都可以被唯一标识。</p>
<p>ObjectId在不同机器上都能用全局唯一的同种方法方便地自动生成它。所以MongoDB采用它，而不是使用自动增长的主键。ObjectId使用12字节的存储空间，每个字节两位十六进制，所以一个ObjectId是一个有24位字符的字符串。</p>
<div class="quote-block"><blockquote><p>ObjectId的前4位表示从标准纪元开始的时间戳，3位表示机器名的散列值，2位表示PID，3位表示计数器。</p></blockquote></div>
<p>ObjectId分别从时间上，同一机器的同一进程的不同时间上产生的ObjectId是唯一的。</p></section></section>
<section class="doc-section level-1"><h2 id="_插入数据">插入数据</h2><p>MongoDB可以批量插入数据，这样可以大大提高插入的速度。原因在于批量的插入相当于有一个TCP头，服务器可以减少解析众多其它TCP头的时间，从而提高了速度。但是批量也不是对TCP数据的大小无所要求，它要求它不能超过<em>16MB</em>.</p>
<p>在MongoDB插入数据的时候，数据首先会被转换成BSON格式的数据，然后检查数据是否包含"_id"键和文档大小是否超过4MB，然后将数据原样保存到数据库。不执行插入数据中的任何命令，可以有效保证数据库不会被注入攻击。但是这样做的坏处就是数据库可能会插入很多无效数据。</p>
<p>如果需要对数据进行检查，在启动数据库的时候可以添加<code>--objcheck</code>选项。</p></section>
<section class="doc-section level-1"><h2 id="_删除数据">删除数据</h2><p>MongoDB删除数据是永久性的，无法进行回滚撤销，所以不太适合事务类的业务。或许这也是它删除文档会很快的原因之一----不用去关注数据库日志保证数据库的完整性。</p></section>
<section class="doc-section level-1"><h2 id="_更新数据">更新数据</h2><p>MongoDB使用update对数据进行更新，它接收两个参数，一个是更新条件，另一个是描述对文档做了哪些修改。</p>
<p><code>$set</code>修改器可以更新某个原子的值：</p>
<div class="literal-block"><pre>db.blog.update({"title": "test"}, {"$set": {"what": "what the hell?"}})</pre></div>
<p><code>$unset</code>可以取消某个原子文档。</p>
<div class="literal-block"><pre>db.blog.update({"title": "test", {"$unset": {"what": 1}}})</pre></div>
<p><code>$inc</code>修改器可以增加已有的键值，或者在不存在的时候创建一个键。</p>
<div class="literal-block"><pre>db.blog.update({"title": "test", {$inc: {"_id": 1}}})</pre></div>
<p><code>update</code>想已有的数组末尾添加一个元素，如果没有该数组，就会创建一个新的数组。</p>
<div class="literal-block"><pre>db.blog.update({"title": "hello"}, {$push : {"comments" : {"name":"test","content":"just for test"}}})</pre></div>
<p>如果一个值不再某个数组里面则加入，如果存在则跳过：</p>
<div class="literal-block"><pre>db.blog.update({"comments": {"$ne": "test"},{$push: {"comments": "test it"}})</pre></div>
<p><code>$addToSet</code>也可以达到同样的效果。</p>
<div class="literal-block"><pre>db.blog.update({"_id":ObjectId("34234")}, {$addToSet: {"emails": "test@example.com"}})</pre></div>
<p><code>$addToSet</code>和<code>$each</code>搭配可以插入多个不同的值：</p>
<div class="literal-block"><pre>db.blog.update({"_id":ObjectId("1231")},{$addToSet:{"emails:":{"$each": ["a","b","c"]}}})</pre></div>
<p><code>$pop</code>可以从数组的任一端删除元素。{$pop : { key : 1 }}从数组尾部删除，{$pop : { key : -1 }}从头部删除。 如果需要基于特定条件删除元素，而不是根据位置，可以使用<code>$pull</code>命令。</p>
<div class="literal-block"><pre>db.blog.update({},{"$pull" : { "title" : "hello world"}})</pre></div>
<p>使用定位符<code>$</code>可以删除<em>第一个匹配</em>的元素：</p>
<div class="literal-block"><pre>db.blog.update({"title":"test"}, {"$set" : {"comments.$.author" : "David"}})</pre></div>
<p>如果知道某个记录的下标还可以使用下标进行指定操作：</p>
<div class="literal-block"><pre>db.blog.update({"title":"test"}, {$inc : { "comments.0.votes" : 1 }})</pre></div>
<p>在文档大小不变的情况下，修改器速度会很快。<code>$inc</code>由于不会修改文档的大小，所以速度非常快。而<code>$set</code>可能会修改文档的大小，所以速度会比较低。</p>
<p><code>upsert</code>是一种特殊的更新。如果没有文档符合更新条件，就会以这个条件和更新文档为基础创建一个新的文档。如果找到了匹配的文档，则正常更新。upsert属于upadte的第三个参数，如果需要使用，只需要将update的第三个参数设置为<code>true</code>即可。</p>
<div class="literal-block"><pre>db.blog.update({"title":"my blog"}, {$inc : { "page.counts" : 1 }}, true)</pre></div>
<p><code>save</code>函数是一个shell函数，可以在文档不存在时插入，在存在时进行更新。save函数会调用upsert。</p>
<div class="literal-block"><pre>post = db.blog.findOne();
post.counts = 0;
db.blog.save(post) # db.blog.update({"_id" : post._id}, x)</pre></div>
<div class="quote-block"><blockquote><p>如果需要更新多个文档，则需要将update的第四个参数设置为true.</p></blockquote></div>
<p>获取更新记录的条数可以使用<code>getLastError</code>命令，键n的值就是所要的数字。</p>
<div class="literal-block"><pre>db.runCommand({getLastError : 1})</pre></div>
<p>获取已更新的文档可以使用<code>findAndModify</code>命令。</p>
<div class="literal-block"><pre>db.runCommand({"findAndModify" : "processes"}, "sort" : { "priority" : -1 }, "update": {"$set" : { "status" : "READY" }})</pre></div></section></section>
<section class="doc-section level-0"><h1 id="_查询_2">查询</h1><section class="doc-section level-1"><h2 id="_find">find</h2><p>find的第一个参数决定了返回哪些文档，也就是它是作为查询的条件的。如果为空，则查询全部数据。</p>
<div class="literal-block"><pre>db.blog.find({ "title": "hello", comments: 0 })</pre></div>
<p><code>$lt</code>,<code>$lte</code>, <code>$gt</code>,<code>$gte</code>,<code>ne</code>分别表示 <code>&gt;</code>, <code>&gt;=</code>, <code>&lt;</code>, <code>&lt;=</code>,<code>!=</code>,使用方法是：     db.blog.find({"age" : { "$lt" : 30}})</p>
<p><code>$or</code>的用法:</p>
<div class="literal-block"><pre>db.blog.find({"$or" : [{condition1: c1, condition2 : c2}]})</pre></div>
<p><code>$in</code>的用法：</p>
<div class="literal-block"><pre>db.blog.find({"cond1" : {"$in" : [c1, c2]})</pre></div>
<p>取反使用<code>$nin</code>。</p>
<p><code>$not</code>的用法：</p>
<div class="literal-block"><pre>db.blog.find({"age" : { "$not" : { "$mod" : [10,1] } }})</pre></div>
<p>上面的句子返回年龄mod 10不为1的文档。</p>
<p>第二个参数用于设定返回的键，如果希望某个键返回，在<code>:</code>后数字应该为1，否则为0，这样就不会返回这个字段了。在没有特殊设定下，<code>_id</code>总是默认返回的。</p>
<p><code>$all</code>用于查询同时满足若干条件的数组，注意它只适用于查询数组。</p>
<div class="literal-block"><pre>db.food.find({"fruit" : { $all : ['apple','banana'] }})</pre></div>
<p>查询数组还可以指定匹配元素的下标。比如上面的fruit可以添加fruit.2，当然这样一来，后面的$all就不能使用了。</p>
<p><code>$slice</code>既可以指定查询结果的条数，也可以制定查询结果的偏移。</p>
<div class="literal-block"><pre>db.blog.posts.find({},{"comments" : { $slice : [20,10] }}) #21-30

db.blog.posts.find({},{"comments" : { $slice : 10 }}) #前十条</pre></div></section>
<section class="doc-section level-1"><h2 id="_查询内嵌文档">查询内嵌文档</h2><div class="literal-block"><pre>db.blog.find({"post.title" : "test", "post.username" : "author1"})</pre></div>
<p>与之相比<code>db.blog.find({"post" : {"title" : "test", "username" : "author1"}})</code>要严格根据条件的顺序进行匹配的，如果文档中添加了其它的字段，就会导致数据无法正常查找到。</p>
<p>点表示法表示"深入潜入文档内部"，这也导致MongoDB不允许插入的文档包含<code>.</code>的原因，如果保存的文档中包含<code>.</code>，那么需要在保存前对其进行特殊处理。</p>
<p>如果匹配的内容是一个数组，那么上面的查询方法是无法起作用的，上面的会匹配数组中的所有元素，这也导致结果是不正确的。为了避免这个问题，需要使用<code>$eleMatch</code>.</p>
<div class="literal-block"><pre>db.blog.find({"post" : { "$eleMatch" : { "title" : post, "username" : "author1" } }})</pre></div>
<p>如果需要比较某个文档内部满足条件的文档，则前面的查询条件是无法得到满足的，所以就有了<code>$where</code>子句。它后面可以跟一个Javascript函数，函数如果返回true，则返回该文档。不过使用它的坏处就是<em>性能</em>，因为BSON数据与要转换为JavaScript对象，然后通过$where字句的表达式运行，而且还不能使用索引，所以效率很低。在使用的时候可以私用非$where子句对条件先进行筛选，使用$where对结果进行调优。</p></section>
<section class="doc-section level-1"><h2 id="_游标">游标</h2><p>如果将执行结果赋值给某个变量，那么这个变量就是一个游标了。游标用于对结果进行遍历，<code>cursor.next</code>取下一个文档，<code>cursor.hasNext()</code>用于查询结果集是否遍历完成。另外，游标实现了<code>forEach</code>迭代器方法：</p>
<div class="literal-block"><pre>var cursor = db.blog.find()
cursor.forEach(function(x) {
 print(x.name);
    });</pre></div>
<p>在调用find的时候，shell并不立即查询数据库，而是等待真正要获取数据的时候才发送查询；这样也可以对查询附加额外的玄仙。</p>
<div class="literal-block"><pre>var cursor = db.blog.find().sort({"x" : 1}).limit(2).skip(3)</pre></div>
<p>在执行<code>hasNext</code>时，shell会立即去获取前100条或4MB大小的数据（取小）。</p>
<div class="literal-block"><pre>var cursor = db.blog.find().limit(50).sort({"price" : -1})</pre></div>
<p>skip在略过的记录数量比较大时，通常就会出现性能问题。如果不能避免使用skip，那么可以利用上次查询的结果来计算获取的下一次数据。</p></section>
<section class="doc-section level-1"><h2 id="_索引">索引</h2><p>创建索引</p>
<div class="literal-block"><pre>db.blog.ensureIndex({"title" : 1, "date" : -1}, {"name" : "myindex", background : true})</pre></div>
<p>删除索引</p>
<div class="literal-block"><pre>db.runCommand({"dropIndexes" : "db_name", "index" : "index_name"})
db.runCommand({"dropIndexes" : "db_name", "index" : "*"}) #delete all the indexes of db_name</pre></div>
<p>地理空间索引</p>
<div class="literal-block"><pre>db.map.ensureIndex({"gps" : "2d"}) #这里需要使用2d</pre></div>
<p>查找附近的点：</p>
<div class="literal-block"><pre>db.map.find({"gps" : { "$near" : [40,30] }}).limit(10)
db.runCommand({geNear : "map", near : [40,30], num : 10})</pre></div>
<p>后者还会返回每个文档到查询点的距离，单位为插入数据的单位。</p></section>
<section class="doc-section level-1"><h2 id="_聚合">聚合</h2><p>获取查询的结果的数据个数：</p>
<div class="listing-block"><pre class="highlight"><code class="language-javascript" data-lang="javascript">    db.blog.count()
    db.blog.count({"title" : ”test})</code></pre></div>
<p>获取不同的值</p>
<div class="literal-block"><pre>db.runCommand({"distinct" : "blog", "key" : "title"}) #键是必需的</pre></div>
<p>分组获取数据。以获取大于某日的股票收市价格为例:</p>
<div class="listing-block"><pre class="highlight"><code class="language-javascript" data-lang="javascript">db.runCommand({"group" : {
  "ns" : "price", #文档名称
  "key" : "init_date", #key
  "initial" : {"time" : 0} #initial value
  "$reduce" : function(doc, prev){
                if (doc.time &gt; prev.time){
                  prev.price = doc.price;
                  prev.time = doc.time;
                }
              }
}}, {"condition" : {"day" : {"$gt" : "20120801"}}})


#eg.2
db.runCommand({"group" :{
 "ns" : "price",
 "key" : {"tags" : true}],
 "initial" : {"tags" : {}},
 "$reduce" : function(doc,prev){
               for (i in doc.tags){
                 if(doc.tags[i] in prev.tags){
                   prev.tags[doc.tags[i]] ++;
                   }else{
                    prev.tags[doc.tags[i]] = 1;
                   }
                }
             },
"finalize" : function(prev) {
  var mostPopular = 0;
  for (i in prev.tags){
    if (prev.tags[i] &gt; mostPopular){
      prev.tag = i;
      mostPopular = prev.tags[i];
    }
  }
  delete prev.tags;
}
}})</code></pre></div>
<p>MapReduce的操作过程：映射，将操作映射到集合中的每个文档；洗牌，按照键分组，并将产生的键值组成列表放在对应的键中；化简，将列表中的值化简成一个单值。继续上面的过程，直到每个键的列表只有一个值结束。</p>
<div class="listing-block"><pre class="highlight"><code class="language-javascript" data-lang="javascript">#get all the keys in a document
map = function(){
  for(var key in this){
    emit(key, {count : 1});
  }
};

reduce = function(key, emits){
  total = 0;
  for (var i in emits){
   total += emits[i].count;
  }
  return {"count" : total}
}

mr = db.runCommand({"mapreduce": "blog", "map" : map, "reduce" : reduce},out : {replace:"mr", db: "test"})
{
 "result" : {
  "db" : "test",
  "collection" : "mr"
  },
  "timeMillis" : 353, #执行时间
  "counts" : {
  "input" : 1,  #集合个数
  "emit" : 2,  #emit被调用的次数
  "reduce" : 0, #reduce的次数
  "output" : 2  #结果集合中创建文档的数量
  },
  "ok" : 1
}

db.mr.find() #显示详细信息</code></pre></div></section>
<section class="doc-section level-1"><h2 id="_mongodb命令">MongoDB命令</h2><p>MongoDB的命令其实是作为特殊的查询来实现的，这些查询的集合为<code>$cmd</code>，runCommand仅仅是接收命令文档，执行等价查询，如db.runCommand({"drop" : "test"})等价于<code>db.$cmd.find({"drop" : "test"})</code>。</p>
<p>创建固定集合:     db.createCollection("my_collection", {capped: true, size:10000, max:100}) #固定集合，大小为1000字节，最大可以容纳100个文档。</p>
<p>固定集合的文档按照顺序存储的，而且只有固定集合是顺序存储的，在对查询结果进行排序的时候，可以制定排序的方式。</p>
<div class="literal-block"><pre>db.my_collection.find().sort({"natural": -1}) #逆序</pre></div>
<p><code>尾部有标</code>和<code>tail -f</code>命令类似，它不会获取不到数据后自动销毁游标，一旦有新的文档添加到集合中，新添加的文档就会被取出并输出。</p></section>
<section class="doc-section level-1"><h2 id="_gridfs存储文件">GridFS存储文件</h2><p>GridFS是MongoDB存储大二进制文件的机制，使用它可以:</p>
<div class="ulist"><ul><li>简化需求，GridFS不需要使用独立文件存储架构。</li><li>直接利用业已建立的复制或分片机制，对文件存储和故障恢复及扩展都很容易。</li><li>避免用户用于存储的文件系统出现问题。</li><li><p>可以不产生磁盘碎片，因为MongoDB分配数据空间以2GB为一块。</p><p>─ ➤  mongofiles put logfile    connected to: 127.0.0.1   added file: { _id: ObjectId('501e5b94d6079bdd94ce708d'), filename: "logfile", chunkSize: 262144, uploadDate: new Date(1344166804850), md5: "70377c17d05fe2aa19bf8209137dfdc4", length: 27 }   done!
─ ➤  mongofiles list     +   connected to: 127.0.0.1   logfile	27   ─ ➤  rm logfile   ─ ➤  mongofiles get logfile   connected to: 127.0.0.1   done write to: logfile   ─ ➤  mongofiles search logfile   connected to: 127.0.0.1   logfile	27   ─ ➤  mongofiles delete logfile   connected to: 127.0.0.1   done!</p></li></ul></div>
<p>GridFS是一个建立在普通MongoDB文档基础上的轻量级文件存储规范。GridFS的基本思想是将大文件分成很多块，每块作为单独的文档存储，这样就能存储大文件。MongoDB支持在文档中存储二进制数据，所以可以最大限度地减小块的存储开销。除了存储文件本身的块，还有一个单独的文档用来存储分块信息和文件元数据。</p></section></section>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">polarlights</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
      2012-07-30
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="http://localhost:1313/tags/mongodb/">mongodb</a>
          <a href="http://localhost:1313/tags/nosql/">nosql</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/the-usage-of-spreadsheet-and-read-write-excel-files/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">Spreadsheet是神马</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/post/reflection-and-metaprograming/">
            <span class="next-text nav-default">定义</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  

  

  

  <div class="disqus-comment">
  <div class="disqus-button" id="load_disqus" onclick="load_disqus()">
    Show Disqus Comments
  </div>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
      this.page.url = "http://localhost:1313/post/notes-about-mongodb/";
    };
    function load_disqus() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'PolarLights';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);

      $('#load_disqus').remove();
    };
  </script>
  <noscript>Please enable JavaScript to view the
    <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
  </noscript>
  
  </div>

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:godhuyang@hotmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/polarlights" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>


<a href="http://localhost:1313/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2012 -
    2020
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        polarlights
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  














  <script src="/js/prism.js"></script>

  <script src="/js/fix-adoc.js"></script>


</body>

</html>